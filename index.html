<!DOCTYPE html>
<html>
<head>
    <title>Tour Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        let map;
        let directionsService;
        let directionsRenderer;
        let userMarker;
        let tourMarkers = [];
        let currentTour = 'downtown';

        // Define your tours here - add as many as you need
        const tours = {
            downtown: {
                name: "Downtown LA Food Tour",
                stops: [
                    { lat: 34.0522, lng: -118.2437, name: "Grand Central Market", type: "start" },
                    { lat: 34.0508, lng: -118.2467, name: "Walt Disney Concert Hall", type: "attraction" },
                    { lat: 34.0494, lng: -118.2543, name: "The Broad Museum", type: "museum" },
                    { lat: 34.0502, lng: -118.2560, name: "Angel's Flight", type: "landmark" },
                    { lat: 34.0480, lng: -118.2540, name: "Pershing Square", type: "park" },
                    { lat: 34.0440, lng: -118.2500, name: "Little Tokyo", type: "food" },
                    { lat: 34.0425, lng: -118.2485, name: "Arts District", type: "shopping" },
                    { lat: 34.0445, lng: -118.2345, name: "Union Station", type: "end" }
                ]
            },
            hollywood: {
                name: "Hollywood Landmarks",
                stops: [
                    { lat: 34.1018, lng: -118.3407, name: "Hollywood Sign Viewpoint", type: "start" },
                    { lat: 34.1019, lng: -118.3396, name: "Griffith Observatory", type: "attraction" },
                    { lat: 34.1022, lng: -118.3269, name: "Hollywood Bowl", type: "venue" },
                    { lat: 34.1016, lng: -118.3416, name: "Walk of Fame - Highland", type: "landmark" },
                    { lat: 34.1016, lng: -118.3426, name: "TCL Chinese Theatre", type: "theater" },
                    { lat: 34.1018, lng: -118.3442, name: "Dolby Theatre", type: "theater" },
                    { lat: 34.0981, lng: -118.3267, name: "Capitol Records Building", type: "landmark" },
                    { lat: 34.0928, lng: -118.3287, name: "Sunset Strip", type: "end" }
                ]
            },
            beach: {
                name: "Santa Monica Beach Tour",
                stops: [
                    { lat: 34.0194, lng: -118.4912, name: "Santa Monica Pier", type: "start" },
                    { lat: 34.0195, lng: -118.4975, name: "Third Street Promenade", type: "shopping" },
                    { lat: 34.0169, lng: -118.4963, name: "Santa Monica Beach", type: "beach" },
                    { lat: 34.0118, lng: -118.4951, name: "Venice Beach Boardwalk", type: "attraction" },
                    { lat: 34.0097, lng: -118.4931, name: "Muscle Beach", type: "landmark" },
                    { lat: 34.0049, lng: -118.4846, name: "Abbot Kinney Boulevard", type: "shopping" },
                    { lat: 33.9850, lng: -118.4695, name: "Manhattan Beach Pier", type: "end" }
                ]
            }
        };

        // Apple Maps-style pin markers
        const markerStyles = {
            start: {
                url: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='40' viewBox='0 0 30 40'%3E%3Cpath d='M15 0C6.7 0 0 6.7 0 15c0 8.3 15 25 15 25s15-16.7 15-25C30 6.7 23.3 0 15 0z' fill='%2334C759' stroke='white' stroke-width='2'/%3E%3Ctext x='15' y='20' text-anchor='middle' fill='white' font-size='14' font-weight='bold'%3ES%3C/text%3E%3C/svg%3E",
                scaledSize: new google.maps.Size(30, 40),
                anchor: new google.maps.Point(15, 40)
            },
            end: {
                url: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='40' viewBox='0 0 30 40'%3E%3Cpath d='M15 0C6.7 0 0 6.7 0 15c0 8.3 15 25 15 25s15-16.7 15-25C30 6.7 23.3 0 15 0z' fill='%23FF3B30' stroke='white' stroke-width='2'/%3E%3Ctext x='15' y='20' text-anchor='middle' fill='white' font-size='14' font-weight='bold'%3EE%3C/text%3E%3C/svg%3E",
                scaledSize: new google.maps.Size(30, 40),
                anchor: new google.maps.Point(15, 40)
            },
            food: {
                url: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='25' height='35' viewBox='0 0 25 35'%3E%3Cpath d='M12.5 0C5.6 0 0 5.6 0 12.5c0 6.9 12.5 22.5 12.5 22.5s12.5-15.6 12.5-22.5C25 5.6 19.4 0 12.5 0z' fill='%23FF9500' stroke='white' stroke-width='1.5'/%3E%3Ccircle cx='12.5' cy='12.5' r='4' fill='white'/%3E%3C/svg%3E",
                scaledSize: new google.maps.Size(25, 35),
                anchor: new google.maps.Point(12.5, 35)
            },
            attraction: {
                url: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='25' height='35' viewBox='0 0 25 35'%3E%3Cpath d='M12.5 0C5.6 0 0 5.6 0 12.5c0 6.9 12.5 22.5 12.5 22.5s12.5-15.6 12.5-22.5C25 5.6 19.4 0 12.5 0z' fill='%23007AFF' stroke='white' stroke-width='1.5'/%3E%3Ccircle cx='12.5' cy='12.5' r='4' fill='white'/%3E%3C/svg%3E",
                scaledSize: new google.maps.Size(25, 35),
                anchor: new google.maps.Point(12.5, 35)
            },
            museum: {
                url: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='25' height='35' viewBox='0 0 25 35'%3E%3Cpath d='M12.5 0C5.6 0 0 5.6 0 12.5c0 6.9 12.5 22.5 12.5 22.5s12.5-15.6 12.5-22.5C25 5.6 19.4 0 12.5 0z' fill='%235856D6' stroke='white' stroke-width='1.5'/%3E%3Ccircle cx='12.5' cy='12.5' r='4' fill='white'/%3E%3C/svg%3E",
                scaledSize: new google.maps.Size(25, 35),
                anchor: new google.maps.Point(12.5, 35)
            },
            landmark: {
                url: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='25' height='35' viewBox='0 0 25 35'%3E%3Cpath d='M12.5 0C5.6 0 0 5.6 0 12.5c0 6.9 12.5 22.5 12.5 22.5s12.5-15.6 12.5-22.5C25 5.6 19.4 0 12.5 0z' fill='%23FFCC02' stroke='white' stroke-width='1.5'/%3E%3Ccircle cx='12.5' cy='12.5' r='4' fill='white'/%3E%3C/svg%3E",
                scaledSize: new google.maps.Size(25, 35),
                anchor: new google.maps.Point(12.5, 35)
            },
            shopping: {
                url: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='25' height='35' viewBox='0 0 25 35'%3E%3Cpath d='M12.5 0C5.6 0 0 5.6 0 12.5c0 6.9 12.5 22.5 12.5 22.5s12.5-15.6 12.5-22.5C25 5.6 19.4 0 12.5 0z' fill='%23FF2D92' stroke='white' stroke-width='1.5'/%3E%3Ccircle cx='12.5' cy='12.5' r='4' fill='white'/%3E%3C/svg%3E",
                scaledSize: new google.maps.Size(25, 35),
                anchor: new google.maps.Point(12.5, 35)
            },
            park: {
                url: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='25' height='35' viewBox='0 0 25 35'%3E%3Cpath d='M12.5 0C5.6 0 0 5.6 0 12.5c0 6.9 12.5 22.5 12.5 22.5s12.5-15.6 12.5-22.5C25 5.6 19.4 0 12.5 0z' fill='%2330D158' stroke='white' stroke-width='1.5'/%3E%3Ccircle cx='12.5' cy='12.5' r='4' fill='white'/%3E%3C/svg%3E",
                scaledSize: new google.maps.Size(25, 35),
                anchor: new google.maps.Point(12.5, 35)
            },
            beach: {
                url: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='25' height='35' viewBox='0 0 25 35'%3E%3Cpath d='M12.5 0C5.6 0 0 5.6 0 12.5c0 6.9 12.5 22.5 12.5 22.5s12.5-15.6 12.5-22.5C25 5.6 19.4 0 12.5 0z' fill='%2332D2FF' stroke='white' stroke-width='1.5'/%3E%3Ccircle cx='12.5' cy='12.5' r='4' fill='white'/%3E%3C/svg%3E",
                scaledSize: new google.maps.Size(25, 35),
                anchor: new google.maps.Point(12.5, 35)
            },
            venue: {
                url: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='25' height='35' viewBox='0 0 25 35'%3E%3Cpath d='M12.5 0C5.6 0 0 5.6 0 12.5c0 6.9 12.5 22.5 12.5 22.5s12.5-15.6 12.5-22.5C25 5.6 19.4 0 12.5 0z' fill='%23AF52DE' stroke='white' stroke-width='1.5'/%3E%3Ccircle cx='12.5' cy='12.5' r='4' fill='white'/%3E%3C/svg%3E",
                scaledSize: new google.maps.Size(25, 35),
                anchor: new google.maps.Point(12.5, 35)
            },
            theater: {
                url: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='25' height='35' viewBox='0 0 25 35'%3E%3Cpath d='M12.5 0C5.6 0 0 5.6 0 12.5c0 6.9 12.5 22.5 12.5 22.5s12.5-15.6 12.5-22.5C25 5.6 19.4 0 12.5 0z' fill='%23AC8E68' stroke='white' stroke-width='1.5'/%3E%3Ccircle cx='12.5' cy='12.5' r='4' fill='white'/%3E%3C/svg%3E",
                scaledSize: new google.maps.Size(25, 35),
                anchor: new google.maps.Point(12.5, 35)
            },
            default: {
                url: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='25' height='35' viewBox='0 0 25 35'%3E%3Cpath d='M12.5 0C5.6 0 0 5.6 0 12.5c0 6.9 12.5 22.5 12.5 22.5s12.5-15.6 12.5-22.5C25 5.6 19.4 0 12.5 0z' fill='%238E8E93' stroke='white' stroke-width='1.5'/%3E%3Ccircle cx='12.5' cy='12.5' r='4' fill='white'/%3E%3C/svg%3E",
                scaledSize: new google.maps.Size(25, 35),
                anchor: new google.maps.Point(12.5, 35)
            }
        };

        function initMap() {
            console.log('Initializing map...');
            
            try {
                // Initialize map
                map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 12,
                    center: { lat: 34.0522, lng: -118.2437 },
                    mapTypeId: "roadmap",
                });

                // Initialize directions service and renderer
                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer({
                    draggable: false,
                    suppressMarkers: true, // We'll add custom markers
                    polylineOptions: {
                        strokeColor: "#1E90FF",
                        strokeWeight: 4,
                        strokeOpacity: 0.8
                    }
                });
                directionsRenderer.setMap(map);

                // Check URL for location from Draftbit
                checkURLForLocation();

                // Load initial tour
                loadTour();

                console.log('Map initialization complete');
            } catch (error) {
                console.error('Map initialization error:', error);
            }
        }

        function loadTour() {
            try {
                const tour = tours[currentTour];
                
                // Clear existing markers
                clearTourMarkers();
                
                // Add tour markers
                addTourMarkers(tour.stops);
                
                // Show route
                showRoute();
            } catch (error) {
                console.error('Load tour error:', error);
            }
        }

        function clearTourMarkers() {
            tourMarkers.forEach(marker => {
                try {
                    marker.setMap(null);
                } catch (e) {
                    console.warn('Error clearing marker:', e);
                }
            });
            tourMarkers = [];
        }

        function addTourMarkers(stops) {
            stops.forEach((stop, index) => {
                try {
                    const iconUrl = markerStyles[stop.type] || markerStyles.default;
                    
                    const marker = new google.maps.Marker({
                        position: { lat: stop.lat, lng: stop.lng },
                        map: map,
                        title: `${index + 1}. ${stop.name}`,
                        icon: {
                            url: iconUrl,
                            scaledSize: new google.maps.Size(32, 32)
                        },
                        zIndex: 100 + index
                    });

                    // Add info window
                    const infoWindow = new google.maps.InfoWindow({
                        content: `<div style="font-size: 14px;"><strong>Stop ${index + 1}</strong><br>${stop.name}<br><em>${stop.type}</em></div>`
                    });

                    marker.addListener('click', () => {
                        infoWindow.open(map, marker);
                    });

                    tourMarkers.push(marker);
                } catch (error) {
                    console.error('Error adding marker:', error);
                }
            });
        }

        function showRoute() {
            try {
                const tour = tours[currentTour];
                if (tour.stops.length < 2) return;

                console.log('Showing route for', tour.name);
                
                // Create waypoints (all stops except first and last)
                const waypoints = tour.stops.slice(1, -1).map(stop => ({
                    location: { lat: stop.lat, lng: stop.lng },
                    stopover: true
                }));

                const request = {
                    origin: { lat: tour.stops[0].lat, lng: tour.stops[0].lng },
                    destination: { lat: tour.stops[tour.stops.length - 1].lat, lng: tour.stops[tour.stops.length - 1].lng },
                    waypoints: waypoints,
                    optimizeWaypoints: false,
                    travelMode: google.maps.TravelMode.DRIVING,
                    unitSystem: google.maps.UnitSystem.IMPERIAL,
                };

                directionsService.route(request, function(result, status) {
                    try {
                        if (status === "OK") {
                            console.log('Route loaded successfully');
                            directionsRenderer.setDirections(result);
                        } else {
                            console.error('Route error:', status);
                        }
                    } catch (error) {
                        console.error('Route callback error:', error);
                    }
                });
            } catch (error) {
                console.error('Show route error:', error);
            }
        }

        function fitMapToTour() {
            try {
                const tour = tours[currentTour];
                const bounds = new google.maps.LatLngBounds();
                
                tour.stops.forEach(stop => {
                    bounds.extend({ lat: stop.lat, lng: stop.lng });
                });
                
                map.fitBounds(bounds);
                setTimeout(() => {
                    if (map.getZoom() > 14) {
                        map.setZoom(14);
                    }
                }, 100);
            } catch (error) {
                console.error('Fit map error:', error);
            }
        }

        function checkURLForLocation() {
            try {
                const params = new URLSearchParams(window.location.search);
                const lat = params.get('lat');
                const lng = params.get('lng');
                
                if (lat && lng) {
                    console.log('Location received from Draftbit:', lat, lng);
                    showUserLocation(parseFloat(lat), parseFloat(lng));
                } else {
                    console.log('No location parameters in URL');
                }
            } catch (error) {
                console.error('Check URL error:', error);
            }
        }

        function showUserLocation(lat, lng) {
            try {
                console.log('Showing user location:', lat, lng);
                
                // Remove previous user marker
                if (userMarker) {
                    userMarker.setMap(null);
                }

                // Add blue user marker
                userMarker = new google.maps.Marker({
                    position: { lat: lat, lng: lng },
                    map: map,
                    title: "Your Location",
                    icon: {
                        url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                        scaledSize: new google.maps.Size(32, 32)
                    },
                    zIndex: 1000
                });

                console.log('User location updated:', lat.toFixed(4), lng.toFixed(4));
            } catch (error) {
                console.error('Show user location error:', error);
            }
        }

        // Global functions for Draftbit integration
        window.setUserLocation = function(lat, lng) {
            try {
                if (!isNaN(lat) && !isNaN(lng)) {
                    showUserLocation(Number(lat), Number(lng));
                }
            } catch (error) {
                console.error('Set user location error:', error);
            }
        };

        window.switchTour = function(tourKey) {
            try {
                if (tours[tourKey]) {
                    currentTour = tourKey;
                    loadTour();
                }
            } catch (error) {
                console.error('Switch tour error:', error);
            }
        };

        window.fitMapToTour = fitMapToTour;

        // Message listener for Draftbit
        document.addEventListener('message', event => {
            try {
                const data = JSON.parse(event.data);
                if (data.lat && data.lng) {
                    showUserLocation(data.lat, data.lng);
                }
                if (data.tour) {
                    window.switchTour(data.tour);
                }
                if (data.action === 'fitMap') {
                    fitMapToTour();
                }
            } catch (e) {
                console.log('Message parsing error:', e);
            }
        });

        // Handle any uncaught errors
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Global error:', msg, 'at', url, lineNo, columnNo);
            return false;
        };
    </script>

    <!-- Load Google Maps API -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDdD8BAz34j_0zv-G3qJKTP5sKQn7PQ1w&callback=initMap"
        onerror="handleMapLoadError()">
    </script>
    
    <script>
        function handleMapLoadError() {
            console.error('Failed to load Google Maps API');
            document.getElementById('map').innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f5f5f5; flex-direction: column; padding: 20px; text-align: center;">
                    <h2 style="color: #d32f2f;">Google Maps API Error</h2>
                    <p>The Google Maps API failed to load. Common fixes:</p>
                    <ol style="text-align: left; max-width: 500px;">
                        <li><strong>Billing:</strong> Enable billing in Google Cloud Console</li>
                        <li><strong>API:</strong> Enable "Maps JavaScript API" in your project</li>
                        <li><strong>Restrictions:</strong> Add your domain to API key restrictions</li>
                        <li><strong>Quotas:</strong> Check if you've exceeded daily limits</li>
                    </ol>
                    <p>Check the browser console for specific error messages.</p>
                </div>
            `;
        }
    </script>
</body>
</html>
